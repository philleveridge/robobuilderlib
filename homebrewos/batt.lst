''''''''''''''''''''''''''''''''''''''''''
'
' Battery Charging
'
' Memory
' $06D9 / $06DA
'
'''''''	'''''''''''''''''''''''''''''''''''
				L1304:	BSET 6
003CA9  F826    	BLD R2,6
003CAA  E0E5    	LDI ZL,$05
003CAB  E0F0    	LDI ZH,$00
003CAC  93E0    	STS $06D9,ZL   minutes
003CAD  06D9
003CAE  93F0    	STS $06DA,ZH     06D9=5
003CAF  06DA
003CB0  91E0    L786:	LDS ZL,$06D9      'trickle charge 5 mins
003CB1  06D9
003CB2  91F0    	LDS ZH,$06DA
003CB3  06DA
003CB4  9730    	SBIW ZH:ZL,0      5 mins up
003CB5  F161    	BREQ L783         
003CB6  9AAF    	SBI PORTC,PC7	'Red LED
003CB7  91E0    	LDS ZL,$0065
003CB8  0065
003CB9  7FEB    	ANDI ZL,$FB
003CBA  93E0    	STS $0065,ZL	'Green LED
003CBB  0065
003CBC  940E    	CALL L784	'ReadADC
003CBD  693E
003CBE  940E    	CALL L785	'test
003CBF  3C5B
003CC0  FE25    	SBRS R2,5
003CC1  C020    	RJMP L783
003CC2  9AC4    	SBI PORTB,PB4	'Battery charging on
003CC3  E2E8    	LDI ZL,$28
003CC4  E0F0    	LDI ZH,$00
003CC5  93FA    	ST -Y,ZH
003CC6  93EA    	ST -Y,ZL
003CC7  940E    	CALL L537	'Delay(40)
003CC8  6A4C
003CC9  98C4    	CBI PORTB,PB4	'Battery charging off
003CCA  ECEC    	LDI ZL,$CC
003CCB  E0F1    	LDI ZH,$01
003CCC  93FA    	ST -Y,ZH
003CCD  93EA    	ST -Y,ZL
003CCE  940E    	CALL L537	'Delay(460)
003CCF  6A4C
003CD0  91E0    	LDS ZL,$0065
003CD1  0065
003CD2  60E4    	ORI ZL,$04
003CD3  93E0    	STS $0065,ZL	'Green LED
003CD4  0065
003CD5  940E    	CALL L784	'ReadADC
003CD6  693E
003CD7  940E    	CALL L785	'Test Voltage = ?
003CD8  3C5B
003CD9  FE25    	SBRS R2,5
003CDA  C007    	RJMP L783	'Break;
003CDB  EFE4    	LDI ZL,$F4
003CDC  E0F1    	LDI ZH,$01
003CDD  93FA    	ST -Y,ZH
003CDE  93EA    	ST -Y,ZL
003CDF  940E    	CALL L537	'Delay(500)
003CE0  6A4C
003CE1  CFCE    	RJMP L786

003CE2  E5E5    L783:	LDI ZL,$55     'fast charge
003CE3  E0F0    	LDI ZH,$00
003CE4  93E0    	STS $06D9,ZL         55 minutes
003CE5  06D9
003CE6  93F0    	STS $06DA,ZH         $069A = $55  ( 85 )
003CE7  06DA
003CE8  91E0    L792:	LDS ZL,$06D9
003CE9  06D9
003CEA  91F0    	LDS ZH,$06DA
003CEB  06DA
003CEC  9730    	SBIW ZH:ZL,0
003CED  F129    	BREQ L787
003CEE  9AAF    	SBI PORTC,PC7     red light on
003CEF  91A0    	LDS XL,$06D2    gMSEC
003CF0  06D2
003CF1  91B0    	LDS XH,$06D3    gMSEC
003CF2  06D3
003CF3  3FA5    	CPI XL,$F5
003CF4  E0E1    	LDI ZL,$01                  
003CF5  07BE    	CPC XH,ZL
003CF6  F020    	BRCS L788        if 500 msec
003CF7  91E0    	LDS ZL,$0065
003CF8  0065
003CF9  7FEB    	ANDI ZL,$FB            clear bit 3  Green LED ?
003CFA  C003    	RJMP L789
003CFB  91E0    L788:	LDS ZL,$0065
003CFC  0065
003CFD  60E4    	ORI ZL,$04               sets bit 3
003CFE  93E0    L789:	STS $0065,ZL
003CFF  0065
003D00  91A0    	LDS XL,$06D2           gMSEC
003D01  06D2
003D02  91B0    	LDS XH,$06D3		   gMSEC
003D03  06D3
003D04  940E    	CALL L750           if gMsec =  0 ?
003D05  6CAE
003D06  F021    	BREQ L790
003D07  3FA4    	CPI XL,$F4
003D08  E0E1    	LDI ZL,$01
003D09  07BE    	CPC XH,ZL
003D0A  F421    	BRNE L791          if gMsec =  500 ?
003D0B  940E    L790:	CALL L784
003D0C  693E
003D0D  940E    	CALL L785
003D0E  3C5B
003D0F  FE25    L791:	SBRS R2,5       if R2,5 is clear then charging done?
003D10  C002    	RJMP L787
003D11  9AC4    	SBI PORTB,PB4           set batter charge on
003D12  CFD5    	RJMP L792
003D13  98C4    L787:	CBI PORTB,PB4       set battery charge off
003D14  94E8    	BCLR 6
003D15  F826    	BLD R2,6
003D16  9508    	RET

006CAE  2400    L750:	CLR R0
006CAF  160A    	CP R0,XL
006CB0  060B    	CPC R0,XH
006CB1  9508    	RET

''''''''''''''''''''''''''''''''''''''''''
'
' ReadADC
'
''''''''''''''''''''''''''''''''''''''''''

00693E  FC24    L784:	SBRC R2,4
00693F  9508    	RET
006940  E0E1    	LDI ZL,$01	'
006941  2E4E    	MOV R4,ZL
006942  9468    	BSET 6
006943  F827    	BLD R2,7
006944  EDEC    	LDI ZL,$DC
006945  93EA    	ST -Y,ZL
006946  940E    	CALL L1339
006947  3C54
006948  FC27    L1438:	SBRC R2,7	'Loop till ready
006949  CFFE    	RJMP L1438
00694A  9508    	RET


		L1339:	MOV ZL,R4
003C55  62E0    	ORI ZL,$20
003C56  B9E7    	OUT ADMUX,ZL
003C57  81E8    	LD ZL,Y
003C58  B9E6    	OUT ADCSRA,ZL
003C59  9621    	ADIW YH:YL,1
003C5A  9508    	RET

''''''''''''''''''''''''''''''''''''''''''
'
' Test If charging complete
'
' 06DD/E
'
''''''''''''''''''''''''''''''''''''''''''

				L785:	SBRC R2,4
003C5C  9508    	RET
003C5D  FE25    	SBRS R2,5
003C5E  C022    	RJMP L776
003C5F  E1EC    	LDI ZL,$1C
003C60  E2F5    	LDI ZH,$25     0x251C = 9500 (U_T_MAX_POWER)
003C61  165E    	CP R5,ZL     ' R5/R6 = voltage mV
003C62  066F    	CPC R6,ZH
003C63  F030    	BRCS L777
003C64  E0E0    	LDI ZL,$00
003C65  93E0    	STS $06DD,ZL
003C66  06DD
003C67  93E0    	STS $06DE,ZL         cnt1=0
003C68  06DE
003C69  C009    	RJMP L778
003C6A  91E0    L777:	LDS ZL,$06DD  
003C6B  06DD
003C6C  91F0    	LDS ZH,$06DE
003C6D  06DE
003C6E  9631    	ADIW ZH:ZL,1
003C6F  93E0    	STS $06DD,ZL          cnt1++
003C70  06DD
003C71  93F0    	STS $06DE,ZH
003C72  06DE
003C73  91A0    L778:	LDS XL,$06DD
003C74  06DD
003C75  91B0    	LDS XH,$06DE
003C76  06DE
003C77  9717    	SBIW XH:XL,7    IF cnt1 >7  ret?
003C78  F038    	BRCS L779
003C79  94E8    	BCLR 6
003C7A  F825    	BLD R2,5        clear R2,5 - chargind done
003C7B  E0E0    	LDI ZL,$00
003C7C  93E0    	STS $06DD,ZL
003C7D  06DD
003C7E  93E0    	STS $06DE,ZL       cnt1=0
003C7F  06DE
003C80  C026    L779:	RJMP L780  (Ret)

003C81  E1EC    L776:	LDI ZL,$1C     (R2,5 is clear) - 
003C82  E2F5    	LDI ZH,$25
003C83  165E    	CP R5,ZL
003C84  066F    	CPC R6,ZH
003C85  F078    	BRCS L781
003C86  E0E0    	LDI ZL,$00
003C87  93E0    	STS $06DD,ZL      cnt1 = 0
003C88  06DD
003C89  93E0    	STS $06DE,ZL
003C8A  06DE
003C8B  91E0    	LDS ZL,$06DB      cnt2++
003C8C  06DB
003C8D  91F0    	LDS ZH,$06DC
003C8E  06DC
003C8F  9631    	ADIW ZH:ZL,1
003C90  93E0    	STS $06DB,ZL
003C91  06DB
003C92  93F0    	STS $06DC,ZH
003C93  06DC
003C94  C005    	RJMP L782
003C95  E0E0    L781:	LDI ZL,$00
003C96  93E0    	STS $06DB,ZL
003C97  06DB
003C98  93E0    	STS $06DC,ZL           cnt2=0
003C99  06DC
003C9A  91A0    L782:	LDS XL,$06DB
003C9B  06DB
003C9C  91B0    	LDS XH,$06DC
003C9D  06DC
003C9E  9713    	SBIW XH:XL,3      
003C9F  F038    	BRCS L780            if cnt2>3 ?
003CA0  9468    	BSET 6
003CA1  F825    	BLD R2,5            set R2, 5 - still charging
003CA2  E0E0    	LDI ZL,$00
003CA3  93E0    	STS $06DB,ZL
003CA4  06DB
003CA5  93E0    	STS $06DC,ZL         cnt2=0
003CA6  06DC
003CA7  9508    L780:	RET











